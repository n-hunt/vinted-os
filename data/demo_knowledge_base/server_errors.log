2025-10-23 14:25:12 - src.main - INFO - ============================================================
2025-10-23 14:25:12 - src.main - INFO - Starting VintedOS ETL Pipeline
2025-10-23 14:25:12 - src.main - INFO - ============================================================
2025-10-23 14:25:12 - src.services.database - INFO - Database engine initialized: vinted_os.db
2025-10-23 14:25:12 - src.services.database - INFO - WAL mode enabled successfully
2025-10-23 14:25:13 - src.services.gmail - INFO - Initializing Gmail API service
2025-10-23 14:25:14 - src.services.gmail - INFO - Gmail API service initialized successfully
2025-10-23 14:25:14 - src.main - INFO - 
=== Step 1: Processing Return Forms ===
2025-10-23 14:25:15 - src.services.gmail - INFO - Fetching attachments matching pattern: ^Order-return-form
2025-10-23 14:25:17 - src.main - INFO - Found 2 return form attachment(s)
2025-10-23 14:25:18 - src.docuflow.parser - INFO - Parsed 3 items from text (TID: 18273645901)
2025-10-23 14:25:18 - src.main - INFO - Parsed return form for TID 18273645901: 3 item(s)
2025-10-23 14:25:19 - src.docuflow.parser - INFO - Parsed 1 items from text (TID: 18273645902)
2025-10-23 14:25:19 - src.main - INFO - Parsed return form for TID 18273645902: 1 item(s)
2025-10-23 14:25:19 - src.main - INFO - 
=== Step 2: Processing Shipping Labels ===
2025-10-23 14:25:20 - src.services.gmail - INFO - Fetching attachments matching pattern: ^Vinted-(?:Label|Digital-Label)
2025-10-23 14:25:22 - src.main - INFO - Found 2 shipping label(s)
2025-10-23 14:25:22 - src.docuflow.vision - DEBUG - Converted PDF to grayscale image: (1654, 2339)
2025-10-23 14:25:22 - src.docuflow.vision - DEBUG - Applied binarization with threshold=200
2025-10-23 14:25:22 - src.docuflow.vision - ERROR - Error during PDF processing: OpenCV error: (-215:Assertion failed) !_src.empty() in function 'cvtColor'
Traceback (most recent call last):
  File "/Users/nickhunt/Desktop/portfolioprojs/vinted-os-db/src/docuflow/vision.py", line 68, in crop_and_resize_to_4x6
    img = self._apply_binarization(img, threshold)
  File "/Users/nickhunt/Desktop/portfolioprojs/vinted-os-db/src/docuflow/vision.py", line 95, in _apply_binarization
    img = img.point(lambda p: 255 if p > threshold else 0)
  File "/usr/local/lib/python3.11/site-packages/PIL/Image.py", line 1547, in point
    return self._new(self.im.point(lut, mode))
cv2.error: OpenCV(4.8.1) /io/opencv/modules/imgproc/src/color.cpp:182: error: (-215:Assertion failed) !_src.empty() in function 'cvtColor'
2025-10-23 14:25:22 - src.main - WARNING - Error processing label Vinted-Label-18273645901.pdf: OpenCV error: (-215:Assertion failed) !_src.empty() in function 'cvtColor'
2025-10-23 14:25:23 - src.docuflow.vision - DEBUG - Converted PDF to grayscale image: (1654, 2339)
2025-10-23 14:25:23 - src.docuflow.vision - DEBUG - Applied binarization with threshold=200
2025-10-23 14:25:23 - src.docuflow.vision - DEBUG - Detected rectangular border at (45, 67, 1609, 2272), cropped from (1654, 2339) to (1564, 2205)
2025-10-23 14:25:23 - src.docuflow.vision - INFO - Successfully processed PDF: 145632 -> 142108 bytes
2025-10-23 14:25:23 - src.main - INFO - Processed label for TID 18273645902
2025-10-23 14:25:23 - src.main - INFO - 
=== Step 3: Matching and Generating Labels ===
2025-10-23 14:25:24 - src.main - WARNING - No return form found for label TID 18273645901, skipping
2025-10-23 14:25:24 - src.docuflow.generator - INFO - Generated label with items overlay for TID 18273645902 (1 item(s))
2025-10-23 14:25:24 - src.main - INFO - Saved enhanced label: ./static/services/labels/18273645902_Vinted-Label-18273645902.pdf
2025-10-23 14:25:24 - src.main - INFO - Matched transaction 18273645902: 1 item(s), 2 message(s)
2025-10-23 14:25:24 - src.main - INFO - Successfully matched 1 transaction(s)
2025-10-23 14:25:24 - src.main - INFO - 
=== Step 4: Printing Labels ===
2025-10-23 14:25:24 - src.services.printer - INFO - Print mode enabled. Printer: Zebra_GK420d
2025-10-23 14:25:24 - src.main - INFO - Printing 1 label(s)
2025-10-23 14:25:24 - src.services.printer - INFO - Attempting to print: ./static/services/labels/18273645902_Vinted-Label-18273645902.pdf
2025-10-23 14:25:24 - src.services.printer - DEBUG - Executing: lp -d Zebra_GK420d -o fit-to-page -o Darkness=30 "./static/services/labels/18273645902_Vinted-Label-18273645902.pdf"
2025-10-23 14:25:25 - src.services.printer - ERROR - Print command failed: lp: Error - unable to connect to printer "Zebra_GK420d" at 192.168.1.50 - Connection timed out
2025-10-23 14:25:25 - src.services.printer - INFO - Retry 1/3: Attempting to reconnect to printer...
2025-10-23 14:25:30 - src.services.printer - ERROR - Print command failed: lp: Error - unable to connect to printer "Zebra_GK420d" at 192.168.1.50 - Connection timed out
2025-10-23 14:25:30 - src.services.printer - INFO - Retry 2/3: Attempting to reconnect to printer...
2025-10-23 14:25:35 - src.services.printer - ERROR - Print command failed: lp: Error - unable to connect to printer "Zebra_GK420d" at 192.168.1.50 - Connection timed out
2025-10-23 14:25:35 - src.services.printer - ERROR - Print job failed after 3 attempts for transaction 18273645902
2025-10-23 14:25:35 - src.services.database - INFO - Recorded print job for transaction 4: FAILED
2025-10-23 14:25:35 - src.services.database - INFO - Updated transaction 4 status to TransactionStatus.FAILED
2025-10-23 14:25:35 - src.main - INFO - Batch print complete: 0/1 successful
2025-10-23 14:25:35 - src.main - INFO - 
=== Step 5: Cleanup ===
2025-10-23 14:25:35 - src.main - INFO - No messages to clean up
2025-10-23 14:25:35 - src.main - INFO - 
============================================================
2025-10-23 14:25:35 - src.main - INFO - Pipeline Execution Complete
2025-10-23 14:25:35 - src.main - INFO - ============================================================
2025-10-23 14:25:35 - src.services.database - INFO - Ended pipeline run 3: 0 processed, 1 failed
